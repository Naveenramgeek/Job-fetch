name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: true
        type: choice
        options:
          - production
          - staging
        default: production

jobs:
  deploy:
    name: Deploy Backend to Server
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment || 'production' }}
    concurrency:
      group: deploy-production
      cancel-in-progress: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate required secrets
        run: |
          missing=0
          for key in DEPLOY_HOST DEPLOY_USER DEPLOY_SSH_KEY DEPLOY_PATH; do
            if [ -z "${!key}" ]; then
              echo "Missing required secret: $key"
              missing=1
            fi
          done
          if [ "$missing" -eq 1 ]; then
            echo "Add deploy secrets in GitHub repo settings before running deploy."
            exit 1
          fi
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}

      - name: Deploy backend over SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            set -e
            cd "${{ secrets.DEPLOY_PATH }}"
            git fetch origin
            git checkout main
            git pull origin main

            # Backend only. This does not delete untracked files (like .env).
            cd FastAPI
            python3 -m venv .venv || true
            source .venv/bin/activate
            pip install -r requirements.txt

            # Restart API service if configured on server.
            # Ensure deploy user has permissions for this command.
            sudo systemctl restart jobfetch-api
            echo "Backend deployment completed."
